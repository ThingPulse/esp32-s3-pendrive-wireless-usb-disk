<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Table</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    tfoot {
      background-color: #f4f4f4;
    }
    .icon {
      text-align: center;
    }
    .trash-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: red;
    }
    a:link, a:visited, a:hover, a:active {
        text-decoration: none;
        color: #0000BB; /* Example: color: black; */
    }
    body {
    font-family: sans-serif;
}
  </style>
</head>
<body>
  <h1>ThingPulse Pendrive S3 File Server</h1>

  <table border="0">
    <tr>
        <td>
            <label for="newfile">Upload a file</label>
        </td>
        <td>
            <input id="filepath" type="hidden">
            <input id="newfile" type="file" onchange="setpath()" style="width:100%;">
        </td>
    </tr>
    <tr>
        <td><a href="/settings.html">Settings</a></td>
        <td>
            <button id="upload" type="button" onclick="upload()">Upload</button>
        </td>
    </tr>
  </table>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Size</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="cont-files">
    </tbody>
    <tfoot id="disk-info">
    </tbfoot>
  </table>

  <script>
    function setpath() {
        var default_path = document.getElementById("newfile").files[0].name;
        document.getElementById("filepath").value = default_path;
    }
    
    function upload() {
        var filePath = document.getElementById("filepath").value;
        var upload_path = "/upload";
        var fileInput = document.getElementById("newfile").files;
    
        /* Max size of an individual file. Make sure this
         * value is same as that set in file_server.c */
        var MAX_FILE_SIZE = 20*1024*1024;
        var MAX_FILE_SIZE_STR = "20MB";
    
        if (fileInput.length == 0) {
            alert("No file selected!");
        } else if (filePath.length == 0) {
            alert("File path on server is not set!");
        } else if (filePath.indexOf(' ') >= 0) {
            alert("File path on server cannot have spaces!");
        } else if (filePath[filePath.length-1] == '/') {
            alert("File name not specified after path!");
        } else if (fileInput[0].size > MAX_FILE_SIZE) {
            alert("File size must be less than " + MAX_FILE_SIZE_STR);
        } else {
            document.getElementById("newfile").disabled = true;
            document.getElementById("filepath").disabled = true;
            document.getElementById("upload").disabled = true;
    
            var file = fileInput[0];
            var xh = new XMLHttpRequest();
            xh.onreadystatechange = function() {
                if (xh.readyState == 4) {
                    if (xh.status == 200) {
                        document.open();
                        document.write(xh.responseText);
                        document.close();
                    } else if (xh.status == 0) {
                        alert("Server closed the connection abruptly!");
                        location.reload()
                    } else {
                        alert(xh.status + " Error!\n" + xh.responseText);
                        location.reload()
                    }
                }
            };
            var formData = new FormData();
            formData.append("filename", file);
            xh.open("POST", upload_path);
            xh.send(formData);
        }
    }
    
    (function() {
        var loadFiles = dir => {
            var xh = new XMLHttpRequest();
            xh.onreadystatechange = () => {
                if (xh.readyState == 4 && xh.status == 200) {
                    var res = JSON.parse(xh.responseText);
                    var cont = document.querySelector('#cont-files');
                    cont.innerHTML = '';
                    res.forEach(i => {
                        var name = i.name.charAt(0) == '/' ? i.name.substring(1) : i.name
                        var typeIcon = i.type == 'dir' ? 'üìÅ' : 'üìÑ';
                        var size = formatBytes(i.size);
                        cont.innerHTML +=
                        `<tr>
                          <td>${typeIcon} <a href="${i.name}">${name}</a></td>
                          <td>${size}</td>
                          
                          <td>
                                 <form method="post" action="/delete">
                                 <input type="hidden" name="dir" value="${i.name}">
                                 <button type="submit">üóëÔ∏è</button>
                                 </form>
                          </td>
                        </tr>`;

                    });
                };
            };
            xh.open("GET", "/api/list?dir=" + dir, true);
            xh.send(null);
            loadDiskInfo();
        };
    
        loadFiles(window.location.pathname);
    })();

    async function loadDiskInfo() {

      try {
        const response = await fetch('/api/disk');
        if (!response.ok) {
          throw new Error('Network response was not ok ' + response.statusText);
        }
        const data = await response.json();
        const diskInfoElement = document.getElementById('disk-info');
        
        // Construct the table row with the disk information
        diskInfoElement.innerHTML = `
          <tr>
            <td>SD Card Total: ${formatBytes(data.total)}, Used: ${formatBytes(data.used)}, Free: ${formatBytes(data.free)}, Card-Type: ${data.cardType}, Card-Size: ${formatBytes(data.cardSize)}</td>
            <td></td>
            <td></td>
          </tr>
        `;
      } catch (error) {
        console.error('Error loading disk info:', error);
      }
    }

    // Helper function to format bytes into a more readable format
    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Load disk info when the page is loaded
    //document.addEventListener('DOMContentLoaded', loadDiskInfo);
    </script>
</body>
</html>